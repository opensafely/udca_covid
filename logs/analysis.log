
. * Open file to write results to 
. file open tablecontent using ./output/tables/cum_incidence.txt, write text re
> place
(note: file ./output/tables/cum_incidence.txt not found)

. file write tablecontent ("Outcome") _tab ("Exposure") _tab ("Cumulative incid
> ence") _tab ("95% confidence interval") _n

. 
. 
. * plot for each outcome - age and sex adjusted only
. foreach outcome in hosp_any composite_any {
  2.     use ./output/an_dataset_`outcome', clear 
  3.     describe
  4.     gen index_date = date("01/03/2020", "DMY")
  5.     stset stop, fail(`outcome'_flag) id(patient_id) enter(index_date) orig
> in(index_date)
  6. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify  
.     
.     * Age and sex adjusted model 
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time 
.     stpm2 udca age_tv male, tvc(udca) dftvc(1) df(3) scale(hazard) eform
  7.     summ _t
  8.     local tmax=r(max)
  9.     local tmaxplus1=r(max)+1
 10. 
.     range days 0 `tmax' `tmaxplus1'
 11.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci
>  contrast(difference) fail
 12. 
.     gen date = d(1/3/2020)+ days
 13.     format date %tddd_Month
 14. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 15. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("`outcome'") _tab ("No UDCA") _tab  
 16.     * cumulative outcome - no UDCA 
.     sum _at1 if days==`tmax'
 17.     file write tablecontent (r(mean)) _tab 
 18.     sum _at1_lci if days==`tmax'
 19.     file write tablecontent (r(mean)) _tab 
 20.     sum _at1_uci if days==`tmax'
 21.     file write tablecontent (r(mean)) _tab _n 
 22.     * cumulative outcome - UDCA 
.     file write tablecontent ("`outcome'") _tab ("UDCA") _tab  
 23.     sum _at2 if days==`tmax'
 24.     file write tablecontent (r(mean)) _tab 
 25.     sum _at2_lci if days==`tmax'
 26.     file write tablecontent (r(mean)) _tab 
 27.     sum _at2_uci if days==`tmax'
 28.     file write tablecontent (r(mean)) _tab _n 
 29.     
.     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
.     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
 30. 
.     graph export "./output/graphs/adjcurv_`outcome'.svg", as(svg) replace
 31. 
.     * Close window 
.     graph close
 32. 
. }

Contains data from ./output/an_dataset_hosp_any.dta
  obs:         4,845                          
 vars:            17                          18 Aug 2023 09:40
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
patient_id      int     %8.0g                 
male            float   %9.0g                 
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
hosp_any_flag   float   %9.0g                 
wave            float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 

                id:  patient_id
     failure event:  hosp_any_flag != 0 & hosp_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      4,845  total observations
          0  exclusions
------------------------------------------------------------------------------
      4,845  observations remaining, representing
      1,000  subjects
         46  failures in single-failure-per-subject data
    626,377  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -215.29789  
Iteration 1:   log likelihood = -214.82175  
Iteration 2:   log likelihood = -214.80095  
Iteration 3:   log likelihood = -214.80094  

Log likelihood = -214.80094                     Number of obs     =      4,780

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   1.296121   .7230198     0.46   0.642      .434327    3.867892
      age_tv |   1.003491   .0063339     0.55   0.581     .9911534    1.015983
        male |   .6606557    .201309    -1.36   0.174      .363584    1.200454
       _rcs1 |   3.030818   .6964119     4.83   0.000      1.93185    4.754953
       _rcs2 |    1.16839   .2371442     0.77   0.443     .7849149    1.739216
       _rcs3 |   .9861867    .055481    -0.25   0.805     .8832266    1.101149
  _rcs_udca1 |   .7320853   .2496957    -0.91   0.361     .3751789    1.428516
       _cons |   .0263826   .0093237   -10.29   0.000     .0131977    .0527395
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      4,845    473.3583    260.4877          1       1035
(3,809 missing values generated)
(3,809 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    7.307821           .   7.307821   7.307821

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1     5.33401           .    5.33401    5.33401

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    10.01203           .   10.01203   10.01203

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    6.619538           .   6.619538   6.619538

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    2.775402           .   2.775402   2.775402

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    15.78808           .   15.78808   15.78808
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_hosp_any.gph not found)
(file adjcurv_hosp_any.gph saved)
(note: file ./output/graphs/adjcurv_hosp_any.svg not found)
(file ./output/graphs/adjcurv_hosp_any.svg written in SVG format)

Contains data from ./output/an_dataset_composite_any.dta
  obs:         4,845                          
 vars:            17                          18 Aug 2023 09:40
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
patient_id      int     %8.0g                 
male            float   %9.0g                 
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
composite_any~g float   %9.0g                 
wave            float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 

                id:  patient_id
     failure event:  composite_any_flag != 0 & composite_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      4,845  total observations
          0  exclusions
------------------------------------------------------------------------------
      4,845  observations remaining, representing
      1,000  subjects
        221  failures in single-failure-per-subject data
    626,377  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -687.77557  
Iteration 1:   log likelihood = -686.30233  
Iteration 2:   log likelihood = -686.28838  
Iteration 3:   log likelihood = -686.28838  

Log likelihood = -686.28838                     Number of obs     =      4,780

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |    1.15778   .3606526     0.47   0.638     .6287441    2.131957
      age_tv |   1.000265   .0029056     0.09   0.927     .9945861    1.005976
        male |   1.028339   .1395577     0.21   0.837     .7881672    1.341697
       _rcs1 |   2.682506   .2291217    11.55   0.000     2.269012    3.171354
       _rcs2 |   .9659945   .0664639    -0.50   0.615     .8441292    1.105453
       _rcs3 |    .993079   .0222932    -0.31   0.757     .9503325    1.037748
  _rcs_udca1 |   .7159609   .1469888    -1.63   0.104     .4787791     1.07064
       _cons |   .1148538    .018839   -13.19   0.000     .0832773    .1584034
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      4,845    473.3583    260.4877          1       1035
(3,809 missing values generated)
(3,809 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    32.69182           .   32.69182   32.69182

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1    28.95564           .   28.95564   28.95564

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    36.91007           .   36.91007   36.91007

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    26.72478           .   26.72478   26.72478

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1     18.4499           .    18.4499    18.4499

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    38.71099           .   38.71099   38.71099
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_composite_any.gph not found)
(file adjcurv_composite_any.gph saved)
(note: file ./output/graphs/adjcurv_composite_any.svg not found)
(file ./output/graphs/adjcurv_composite_any.svg written in SVG format)

. 
. use ./output/an_dataset_died_covid_any, clear 

.     describe

Contains data from ./output/an_dataset_died_covid_any.dta
  obs:         4,970                          
 vars:            17                          18 Aug 2023 09:40
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
patient_id      int     %8.0g                 
male            float   %9.0g                 
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
died_covid_an~g byte    %8.0g                 
wave            float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 

.     gen index_date = date("01/03/2020", "DMY")

.     stset stop, fail(died_covid_any_flag) id(patient_id) enter(index_date) or
> igin(index_date)

                id:  patient_id
     failure event:  died_covid_any_flag != 0 & died_covid_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      4,970  total observations
          0  exclusions
------------------------------------------------------------------------------
      4,970  observations remaining, representing
      1,000  subjects
        165  failures in single-failure-per-subject data
    646,349  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035

. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify 
.     
.     * Age and sex adjusted model 
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time 
.     stpm2 udca age_tv male, tvc(udca) dftvc(1) df(3) scale(hazard) eform
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -550.85433  
Iteration 1:   log likelihood = -547.38567  
Iteration 2:   log likelihood = -547.27354  
Iteration 3:   log likelihood = -547.27332  
Iteration 4:   log likelihood = -547.27332  

Log likelihood = -547.27332                     Number of obs     =      4,905

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   1.229536   .4386406     0.58   0.562     .6110443    2.474058
      age_tv |   1.000762   .0033375     0.23   0.819     .9942422    1.007325
        male |   1.109574   .1742342     0.66   0.508     .8156311     1.50945
       _rcs1 |   2.893762   .3333865     9.22   0.000     2.308856    3.626841
       _rcs2 |   .9876515   .0920756    -0.13   0.894      .822714    1.185655
       _rcs3 |   .9804574   .0263521    -0.73   0.463      .930145    1.033491
  _rcs_udca1 |   .6727572   .1592186    -1.67   0.094     .4230659    1.069815
       _cons |   .0740927   .0143775   -13.41   0.000     .0506527    .1083799
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

.     summ _t

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      4,970     479.328    261.7109          1       1035

.     local tmax=r(max)

.     local tmaxplus1=r(max)+1

. 
.     range days 0 `tmax' `tmaxplus1'
(3,934 missing values generated)

.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci co
> ntrast(difference) fail

. 
.     gen date = d(1/3/2020)+ days
(3,934 missing values generated)

.     format date %tddd_Month

. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("Death") _tab ("No UDCA") _tab  

.     * cumulative outcome - no UDCA 
.     sum _at1 if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    25.45883           .   25.45883   25.45883

.     file write tablecontent (r(mean)) _tab 

.     sum _at1_lci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1     21.9766           .    21.9766    21.9766

.     file write tablecontent (r(mean)) _tab 

.     sum _at1_uci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    29.49283           .   29.49283   29.49283

.     file write tablecontent (r(mean)) _tab _n 

.     * cumulative outcome - UDCA 
.     file write tablecontent ("Death") _tab ("UDCA") _tab  

.     sum _at2 if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    20.44946           .   20.44946   20.44946

.     file write tablecontent (r(mean)) _tab 

.     sum _at2_lci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    13.13053           .   13.13053   13.13053

.     file write tablecontent (r(mean)) _tab 

.     sum _at2_uci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    31.84793           .   31.84793   31.84793

.     file write tablecontent (r(mean)) _tab _n 

. 
.     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
.     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to COVID-19 death", justification(left) size(
> med) )        ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (0.2) 2, angle(0) format(%4.1f) labsize(small)) 
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative mortality (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_.gph not found)
(file adjcurv_.gph saved)

. 
.     graph export "./output/graphs/adjcurv_died_covid_any.svg", as(svg) replac
> e
(note: file ./output/graphs/adjcurv_died_covid_any.svg not found)
(file ./output/graphs/adjcurv_died_covid_any.svg written in SVG format)

. 
.     * Close window 
.     graph close

.     
. 
.   /* plot for each outcome - fully adjusted - doesn't converge
> foreach outcome in hosp_any composite_any {
>     use ./output/an_dataset_`outcome', clear 
>     describe
>     gen index_date = date("01/03/2020", "DMY")
>     stset stop, fail(`outcome'_flag) id(patient_id) enter(index_date) origin(
> index_date)
> 
>     * Add cumulative incidence plots 
>     * Not stratifying by stp as cannot use tvc and stratify 
>     * Fully adjusted model (though not including wave as not right in main mo
> del)
>     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
>     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time
>     stpm2 udca male any_high_risk_condition i.ethnicity i.imd bmi_cat i.smoki
> ng severe_disease /*covid_vacc_first*/ liver_trans, ///
>      tvc(udca severe_disease /*covid_vacc_first*/ liver_trans age_tv) dftvc(1
> ) df(3) scale(hazard) eform
>    
>     summ _t
>     local tmax=r(max)
>     local tmaxplus1=r(max)+1
> 
>     range days 0 `tmax' `tmaxplus1'
>     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci co
> ntrast(difference) fail
> 
>     gen date = d(1/3/2020)+ days
>     format date %tddd_Month
> 
>     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
> 
>     *cumulative mortality at last day of follow-up
>     list _at1* if days==`tmax', noobs
>     list _at2* if days==`tmax', noobs
>     list _contrast* if days==`tmax', noobs
> 
>     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
> 
>     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(_adjcurv_`outcome', rep
> lace)
> 
>     graph export "./output/graphs/adjcurv_f_`outcome'.svg", as(svg) replace
> 
>     * Close window 
>     graph close
> 
> }
> 
> use ./output/an_dataset_died_covid_any, clear 
>     describe
>     gen index_date = date("01/03/2020", "DMY")
>     stset stop, fail(died_covid_any_flag) id(patient_id) enter(index_date) or
> igin(index_date)
> 
>     * Add cumulative incidence plots 
>     * Not stratifying by stp as cannot use tvc and stratify 
>     * Fully adjusted model - currently not running     
>     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
>     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time
>     stpm2 udca male any_high_risk_condition i.ethnicity i.imd bmi_cat i.smoki
> ng severe_disease covid_vacc_first liver_trans, ///
>      tvc(udca severe_disease covid_vacc_first liver_trans age_tv) dftvc(1) df
> (3) scale(hazard) eform
>     
>     summ _t
>     local tmax=r(max)
>     local tmaxplus1=r(max)+1
> 
>     range days 0 `tmax' `tmaxplus1'
>     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci co
> ntrast(difference) fail
> 
>     gen date = d(1/3/2020)+ days
>     format date %tddd_Month
> 
>     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
> 
>     *cumulative mortality at last day of follow-up
>     list _at1* if days==`tmax', noobs
>     list _at2* if days==`tmax', noobs
>     list _contrast* if days==`tmax', noobs
> 
>     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
> 
>     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (0.2) 2, angle(0) format(%4.1f) labsize(small)) 
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative mortality (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
> 
>     graph export "./output/graphs/adjcurv_f_died_covid_any.svg", as(svg) repl
> ace
> 
>     * Close window 
>     graph close
>     */
. 
.     file close tablecontent

. 
end of do-file

. . file open output using "/tmp/105_analysis_plots.do.d5xh.out", write text re
> place

. . file write output "success" 

. . file close output

. 
end of do-file


