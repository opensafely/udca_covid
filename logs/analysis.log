
. * Open file to write results to 
. file open tablecontent using ./output/tables/cum_incidence.txt, write text re
> place
(note: file ./output/tables/cum_incidence.txt not found)

. file write tablecontent ("Outcome") _tab ("Exposure") _tab ("Cumulative incid
> ence") _tab ("95% confidence interval") _n

. 
. 
. * plot for each outcome - age and sex adjusted only
. foreach outcome in hosp_any composite_any {
  2.     use ./output/an_dataset_`outcome', clear 
  3.     drop if stp==""
  4.     describe
  5.     gen index_date = date("01/03/2020", "DMY")
  6.     bys patient_id (start): gen last = _N==_n 
  7.     tab died_liver_any `outcome'_flag if last==1
  8.     * For sensitivity: generate new stop and update last record to end of 
> study period if died of liver disease 
.     gen stop_new = stop 
  9.     replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_a
> ny==1
 10.     stset stop, fail(`outcome'_flag) id(patient_id) enter(index_date) orig
> in(index_date)
 11. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify  
.     
.     * Age and sex adjusted model 
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time 
.     stpm2 udca age_tv male, tvc(udca) dftvc(1) df(2) scale(hazard) eform
 12.     summ _t
 13.     local tmax=r(max)
 14.     local tmaxplus1=r(max)+1
 15. 
.     range days 0 `tmax' `tmaxplus1'
 16.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci
>  contrast(difference) fail
 17. 
.     gen date = d(1/3/2020)+ days
 18.     format date %tddd_Month
 19. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 20. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("`outcome'") _tab ("No UDCA") _tab  
 21.     * cumulative outcome - no UDCA 
.     sum _at1 if days==`tmax'
 22.     file write tablecontent (r(mean)) _tab 
 23.     sum _at1_lci if days==`tmax'
 24.     file write tablecontent (r(mean)) _tab 
 25.     sum _at1_uci if days==`tmax'
 26.     file write tablecontent (r(mean)) _tab _n 
 27.     * cumulative outcome - UDCA 
.     file write tablecontent ("`outcome'") _tab ("UDCA") _tab  
 28.     sum _at2 if days==`tmax'
 29.     file write tablecontent (r(mean)) _tab 
 30.     sum _at2_lci if days==`tmax'
 31.     file write tablecontent (r(mean)) _tab 
 32.     sum _at2_uci if days==`tmax'
 33.     file write tablecontent (r(mean)) _tab _n 
 34.     
.     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
.     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
 35. 
.     graph export "./output/graphs/adjcurv_`outcome'.svg", as(svg) replace
 36. 
.     * Close window 
.     graph close
 37. 
.     * Post-hoc analysis: Model with liver deaths not censored
.     use ./output/an_dataset_`outcome', clear 
 38.     drop if stp==""
 39.     describe
 40.     gen index_date = date("01/03/2020", "DMY")
 41.     bys patient_id (start): gen last = _N==_n 
 42.     tab died_liver_any `outcome'_flag if last==1
 43.     * For sensitivity: generate new stop and update last record to end of 
> study period if died of liver disease 
.     gen stop_new = stop 
 44.     replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_a
> ny==1
 45.     stset stop_new, fail(`outcome'_flag) id(patient_id) enter(index_date) 
> origin(index_date)
 46. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify  
.     
.     * Age and sex adjusted model 
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time 
.     stpm2 udca age_tv male, tvc(udca) dftvc(1) df(2) scale(hazard) eform
 47.     summ _t
 48.     local tmax=r(max)
 49.     local tmaxplus1=r(max)+1
 50. 
.     range days_ph 0 `tmax' `tmaxplus1'
 51.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days_ph)
>  ci contrast(difference) fail
 52. 
.     gen date = d(1/3/2020)+ days_ph
 53.     format date %tddd_Month
 54. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 55. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("Post-hoc: `outcome'") _tab ("No UDCA") _tab  
 56.     * cumulative outcome - no UDCA 
.     sum _at1 if days_ph==`tmax'
 57.     file write tablecontent (r(mean)) _tab 
 58.     sum _at1_lci if days_ph==`tmax'
 59.     file write tablecontent (r(mean)) _tab 
 60.     sum _at1_uci if days_ph==`tmax'
 61.     file write tablecontent (r(mean)) _tab _n 
 62.     * cumulative outcome - UDCA 
.     file write tablecontent ("`outcome'") _tab ("UDCA") _tab  
 63.     sum _at2 if days_ph==`tmax'
 64.     file write tablecontent (r(mean)) _tab 
 65.     sum _at2_lci if days_ph==`tmax'
 66.     file write tablecontent (r(mean)) _tab 
 67.     sum _at2_uci if days_ph==`tmax'
 68.     file write tablecontent (r(mean)) _tab _n 
 69.     
.     *l date days_ph _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days_ph<
> .
. 
.     twoway  (rarea _at1_lci _at1_uci days_ph, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days_ph, color(blue%25)) ///
>                     (line _at1 days_ph, sort lcolor(red)) ///
>                     (line _at2 days_ph, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
 70. 
.     graph export "./output/graphs/adjcurv_`outcome'_post_hoc.svg", as(svg) re
> place
 71. 
.     * Close window 
.     graph close
 72. }
(1,463 observations deleted)

Contains data from ./output/an_dataset_hosp_any.dta
  obs:         1,470                          
 vars:            23                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
hosp_any_flag   float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
total_hosp      float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

died_liver |     hosp_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       349         25 |       374 
         1 |       122          4 |       126 
-----------+----------------------+----------
     Total |       471         29 |       500 
(92 real changes made)

                id:  patient_id
     failure event:  hosp_any_flag != 0 & hosp_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,470  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,470  observations remaining, representing
        500  subjects
         29  failures in single-failure-per-subject data
    325,834  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -124.07426  
Iteration 1:   log likelihood = -122.91935  
Iteration 2:   log likelihood = -122.78768  
Iteration 3:   log likelihood =  -122.7867  
Iteration 4:   log likelihood =  -122.7867  

Log likelihood =  -122.7867                     Number of obs     =      1,459

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |    .469766   .4587666    -0.77   0.439     .0692805    3.185316
      age_tv |   1.006462    .008055     0.80   0.421     .9907974    1.022374
        male |   1.677254    .649664     1.34   0.182     .7850477    3.583451
       _rcs1 |   5.754312   2.568618     3.92   0.000     2.399014    13.80238
       _rcs2 |   1.452022   .3092385     1.75   0.080     .9565152    2.204217
  _rcs_udca1 |   3.191227   3.428739     1.08   0.280     .3885116    26.21267
       _cons |   .0175585   .0086544    -8.20   0.000     .0066825    .0461353
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,470    537.9714    293.7312          1       1035
(434 missing values generated)
(434 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    8.099085           .   8.099085   8.099085

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1     5.47581           .    5.47581    5.47581

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    11.97908           .   11.97908   11.97908

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1     10.4877           .    10.4877    10.4877

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    3.425975           .   3.425975   3.425975

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    32.10525           .   32.10525   32.10525
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_hosp_any.gph not found)
(file adjcurv_hosp_any.gph saved)
(note: file ./output/graphs/adjcurv_hosp_any.svg not found)
(file ./output/graphs/adjcurv_hosp_any.svg written in SVG format)
(1,463 observations deleted)

Contains data from ./output/an_dataset_hosp_any.dta
  obs:         1,470                          
 vars:            23                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
hosp_any_flag   float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
total_hosp      float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

died_liver |     hosp_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       349         25 |       374 
         1 |       122          4 |       126 
-----------+----------------------+----------
     Total |       471         29 |       500 
(92 real changes made)

                id:  patient_id
     failure event:  hosp_any_flag != 0 & hosp_any_flag < .
obs. time interval:  (stop_new[_n-1], stop_new]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,470  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,470  observations remaining, representing
        500  subjects
         29  failures in single-failure-per-subject data
    379,659  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -126.31179  
Iteration 1:   log likelihood = -125.22735  
Iteration 2:   log likelihood = -125.12238  
Iteration 3:   log likelihood = -125.12175  
Iteration 4:   log likelihood = -125.12175  

Log likelihood = -125.12175                     Number of obs     =      1,459

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   .3874386   .4249617    -0.86   0.387     .0451402    3.325391
      age_tv |   1.005269   .0079559     0.66   0.507     .9897965    1.020984
        male |   1.746398   .6764198     1.44   0.150     .8174351    3.731066
       _rcs1 |   4.687846    1.87999     3.85   0.000     2.136052    10.28809
       _rcs2 |   1.327128   .2671842     1.41   0.160     .8944259     1.96916
  _rcs_udca1 |   3.795926   4.626469     1.09   0.274     .3482366     41.3772
       _cons |   .0176054   .0086566    -8.22   0.000      .006716    .0461511
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,470    574.5871    307.0052          1       1035
(434 missing values generated)
(434 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    7.173225           .   7.173225   7.173225

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1      4.8799           .     4.8799     4.8799

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1     10.5443           .    10.5443    10.5443

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    8.340435           .   8.340435   8.340435

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    2.792393           .   2.792393   2.792393

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    24.91155           .   24.91155   24.91155
(note:  named style med not found in class gsize, default attributes used)
(file adjcurv_hosp_any.gph saved)
(note: file ./output/graphs/adjcurv_hosp_any_post_hoc.svg not found)
(file ./output/graphs/adjcurv_hosp_any_post_hoc.svg written in SVG format)
(1,463 observations deleted)

Contains data from ./output/an_dataset_composite_any.dta
  obs:         1,470                          
 vars:            22                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
composite_any~g float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

died_liver |  composite_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       277         97 |       374 
         1 |       122          4 |       126 
-----------+----------------------+----------
     Total |       399        101 |       500 
(92 real changes made)

                id:  patient_id
     failure event:  composite_any_flag != 0 & composite_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,470  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,470  observations remaining, representing
        500  subjects
        101  failures in single-failure-per-subject data
    325,834  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -321.90537  
Iteration 1:   log likelihood =  -319.7437  
Iteration 2:   log likelihood = -319.55223  
Iteration 3:   log likelihood = -319.55015  
Iteration 4:   log likelihood = -319.55015  

Log likelihood = -319.55015                     Number of obs     =      1,459

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   .6112616   .3052137    -0.99   0.324     .2297244    1.626474
      age_tv |   1.000453   .0042776     0.11   0.916     .9921044    1.008873
        male |   1.070389   .2141927     0.34   0.734     .7231194    1.584431
       _rcs1 |   3.532454   .6939471     6.42   0.000     2.403581    5.191516
       _rcs2 |   1.017282    .113984     0.15   0.878     .8167066    1.267116
  _rcs_udca1 |    1.60055   .8344654     0.90   0.367     .5760835    4.446856
       _cons |   .1074756   .0255077    -9.40   0.000     .0674979    .1711315
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,470    537.9714    293.7312          1       1035
(434 missing values generated)
(434 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    28.67116           .   28.67116   28.67116

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1    23.93855           .   23.93855   23.93855

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1     34.3394           .    34.3394    34.3394

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    26.89446           .   26.89446   26.89446

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    15.03084           .   15.03084   15.03084

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    48.12185           .   48.12185   48.12185
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_composite_any.gph not found)
(file adjcurv_composite_any.gph saved)
(note: file ./output/graphs/adjcurv_composite_any.svg not found)
(file ./output/graphs/adjcurv_composite_any.svg written in SVG format)
(1,463 observations deleted)

Contains data from ./output/an_dataset_composite_any.dta
  obs:         1,470                          
 vars:            22                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
composite_any~g float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

died_liver |  composite_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       277         97 |       374 
         1 |       122          4 |       126 
-----------+----------------------+----------
     Total |       399        101 |       500 
(92 real changes made)

                id:  patient_id
     failure event:  composite_any_flag != 0 & composite_any_flag < .
obs. time interval:  (stop_new[_n-1], stop_new]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,470  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,470  observations remaining, representing
        500  subjects
        101  failures in single-failure-per-subject data
    379,659  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -335.10213  
Iteration 1:   log likelihood = -333.11085  
Iteration 2:   log likelihood = -332.99291  
Iteration 3:   log likelihood =  -332.9924  
Iteration 4:   log likelihood =  -332.9924  

Log likelihood =  -332.9924                     Number of obs     =      1,459

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   .6055475   .3021435    -1.01   0.315     .2277369    1.610138
      age_tv |   .9990574    .004196    -0.22   0.822     .9908671    1.007315
        male |    1.11255   .2225903     0.53   0.594     .7516537    1.646726
       _rcs1 |   3.324498   .6258782     6.38   0.000      2.29867    4.808121
       _rcs2 |   1.044173   .1161852     0.39   0.698      .839574    1.298631
  _rcs_udca1 |    1.54766   .7765371     0.87   0.384     .5788762    4.137759
       _cons |   .1088355    .025613    -9.42   0.000     .0686202    .1726193
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,470    574.5871    307.0052          1       1035
(434 missing values generated)
(434 missing values generated)

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    24.68842           .   24.68842   24.68842

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1    20.60192           .   20.60192   20.60192

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1     29.5855           .    29.5855    29.5855

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1     21.8553           .    21.8553    21.8553

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    12.18393           .   12.18393   12.18393

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    39.20363           .   39.20363   39.20363
(note:  named style med not found in class gsize, default attributes used)
(file adjcurv_composite_any.gph saved)
(note: file ./output/graphs/adjcurv_composite_any_post_hoc.svg not found)
(file ./output/graphs/adjcurv_composite_any_post_hoc.svg written in SVG format)

. 
. use ./output/an_dataset_died_covid_any, clear 

. drop if stp==""
(1,500 observations deleted)

. describe

Contains data from ./output/an_dataset_died_covid_any.dta
  obs:         1,512                          
 vars:            22                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
died_covid_an~g byte    %8.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. gen index_date = date("01/03/2020", "DMY")

. bys patient_id (start): gen last = _N==_n 

. tab died_liver_any died_covid_any_flag if last==1

died_liver |  died_covid_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       297         77 |       374 
         1 |       126          0 |       126 
-----------+----------------------+----------
     Total |       423         77 |       500 

. * For sensitivity: generate new stop and update last record to end of study p
> eriod if died of liver disease 
. gen stop_new = stop 

. replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_any==1
(88 real changes made)

. stset stop, fail(died_covid_any_flag) id(patient_id) enter(index_date) origin
> (index_date)

                id:  patient_id
     failure event:  died_covid_any_flag != 0 & died_covid_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,512  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,512  observations remaining, representing
        500  subjects
         77  failures in single-failure-per-subject data
    338,450  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035

. 
. * Add cumulative incidence plots 
. * Not stratifying by stp as cannot use tvc and stratify 
. 
. * Age and sex adjusted model 
. * Setting df (degrees of freedom for restricted cubic splines) as 3 as this i
> s default 
. * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = linear
>  effect of log time 
. stpm2 udca age_tv male, tvc(udca age_tv) dftvc(1) df(2) scale(hazard) eform
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -265.68589  
Iteration 1:   log likelihood =  -264.6243  
Iteration 2:   log likelihood = -264.33495  
Iteration 3:   log likelihood = -264.32388  
Iteration 4:   log likelihood = -264.32387  

Log likelihood = -264.32387                     Number of obs     =      1,498

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   .6114087   .3558455    -0.85   0.398        .1954    1.913105
      age_tv |   .9961738   .0059715    -0.64   0.522     .9845384    1.007947
        male |   .8841416   .2035703    -0.53   0.593     .5630356    1.388378
       _rcs1 |   2.484563   .6357347     3.56   0.000       1.5047    4.102516
       _rcs2 |   .9320339   .1012974    -0.65   0.517      .753216    1.153304
  _rcs_udca1 |    1.32334   .7659289     0.48   0.628      .425607    4.114659
_rcs_age_tv1 |   1.006132   .0055003     1.12   0.263     .9954096    1.016971
       _cons |   .1046646   .0303868    -7.77   0.000     .0592481    .1848952
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. summ _t

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,512    547.5456    294.9018          1       1035

. local tmax=r(max)

. local tmaxplus1=r(max)+1

. 
. range days 0 `tmax' `tmaxplus1'
(476 missing values generated)

. stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci contra
> st(difference) fail

. 
. gen date = d(1/3/2020)+ days
(476 missing values generated)

. format date %tddd_Month

. 
. for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contrast2
> _1_lci _contrast2_1_uci: replace X=100*X

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

. 
. *cumulative mortality at last day of follow-up - write to file 
. file write tablecontent ("Death") _tab ("No UDCA") _tab  

. * cumulative outcome - no UDCA 
. sum _at1 if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    22.45008           .   22.45008   22.45008

. file write tablecontent (r(mean)) _tab 

. sum _at1_lci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1    18.14367           .   18.14367   18.14367

. file write tablecontent (r(mean)) _tab 

. sum _at1_uci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    27.77862           .   27.77862   27.77862

. file write tablecontent (r(mean)) _tab _n 

. * cumulative outcome - UDCA 
. file write tablecontent ("Death") _tab ("UDCA") _tab  

. sum _at2 if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    18.00275           .   18.00275   18.00275

. file write tablecontent (r(mean)) _tab 

. sum _at2_lci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    8.533634           .   8.533634   8.533634

. file write tablecontent (r(mean)) _tab 

. sum _at2_uci if days==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1      37.979           .     37.979     37.979

. file write tablecontent (r(mean)) _tab _n 

. 
. *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
. twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                 (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                 (line _at1 days, sort lcolor(red)) ///
>                 (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                 , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(11) 
> region(lwidth(none))) ///
>                 title("Time to COVID-19 death", justification(left) size(med)
>  )            ///
>                 yscale(range(0, 1))                                          
>                                            ///
>                 ylabel(0 (0.2) 2, angle(0) format(%4.1f) labsize(small))     
>    ///
>                 xlabel(0 (200) 1035, labsize(small))                         
>                                    ///                     
>                 ytitle("Cumulative mortality (%)", size(medsmall)) ///
>                 xtitle("Days since 1 Mar 2020", size(medsmall))              
>    ///
>                 graphregion(fcolor(white)) saving(adjcurv_`outcome', replace)
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_.gph not found)
(file adjcurv_.gph saved)

. 
. graph export "./output/graphs/adjcurv_died_covid_any.svg", as(svg) replace
(note: file ./output/graphs/adjcurv_died_covid_any.svg not found)
(file ./output/graphs/adjcurv_died_covid_any.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Post-hoc analysis: Model with liver deaths not censored
. use ./output/an_dataset_died_covid_any, clear 

. drop if stp==""
(1,500 observations deleted)

. describe

Contains data from ./output/an_dataset_died_covid_any.dta
  obs:         1,512                          
 vars:            22                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
died_covid_an~g byte    %8.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. gen index_date = date("01/03/2020", "DMY")

. bys patient_id (start): gen last = _N==_n 

. tab died_liver_any died_covid_any_flag if last==1

died_liver |  died_covid_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       297         77 |       374 
         1 |       126          0 |       126 
-----------+----------------------+----------
     Total |       423         77 |       500 

. * For sensitivity: generate new stop and update last record to end of study p
> eriod if died of liver disease 
. gen stop_new = stop 

. replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_any==1
(88 real changes made)

. stset stop_new, fail(died_covid_any_flag) id(patient_id) enter(index_date) or
> igin(index_date)

                id:  patient_id
     failure event:  died_covid_any_flag != 0 & died_covid_any_flag < .
obs. time interval:  (stop_new[_n-1], stop_new]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,512  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,512  observations remaining, representing
        500  subjects
         77  failures in single-failure-per-subject data
    390,704  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035

. 
. * Add cumulative incidence plots 
. * Not stratifying by stp as cannot use tvc and stratify  
. 
. * Age and sex adjusted model 
. * Setting df (degrees of freedom for restricted cubic splines) as 3 as this i
> s default 
. * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = linear
>  effect of log time 
. stpm2 udca age_tv male, tvc(udca) dftvc(1) df(2) scale(hazard) eform
note: delayed entry models are being fitted

Iteration 0:   log likelihood = -278.18477  
Iteration 1:   log likelihood = -276.97973  
Iteration 2:   log likelihood =   -276.784  
Iteration 3:   log likelihood = -276.77908  
Iteration 4:   log likelihood = -276.77907  

Log likelihood = -276.77907                     Number of obs     =      1,498

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
xb           |
        udca |   .6495983   .3707281    -0.76   0.450     .2122565    1.988057
      age_tv |    .998711    .004796    -0.27   0.788     .9893551    1.008155
        male |   .9352079   .2152873    -0.29   0.771     .5956063    1.468443
       _rcs1 |   2.930287   .5375163     5.86   0.000     2.045363    4.198074
       _rcs2 |   .9625162   .1063875    -0.35   0.730     .7750402    1.195341
  _rcs_udca1 |   1.182083   .6384968     0.31   0.757     .4100863     3.40738
       _cons |   .0920777   .0243092    -9.03   0.000     .0548822    .1544819
------------------------------------------------------------------------------
Note: Estimates are transformed only in the first equation.

. summ _t

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          _t |      1,512    582.1052    306.1212          1       1035

. local tmax=r(max)

. local tmaxplus1=r(max)+1

. 
. range days_ph 0 `tmax' `tmaxplus1'
(476 missing values generated)

. stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days_ph) ci con
> trast(difference) fail

. 
. gen date = d(1/3/2020)+ days_ph
(476 missing values generated)

. format date %tddd_Month

. 
. for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contrast2
> _1_lci _contrast2_1_uci: replace X=100*X

->  replace _at1=100*_at1
(1,035 real changes made)

->  replace _at2=100*_at2
(1,035 real changes made)

->  replace _at1_lci=100*_at1_lci
(1,035 real changes made)

->  replace _at1_uci=100*_at1_uci
(1,035 real changes made)

->  replace _at2_lci=100*_at2_lci
(1,035 real changes made)

->  replace _at2_uci=100*_at2_uci
(1,035 real changes made)

->  replace _contrast2_1=100*_contrast2_1
(1,035 real changes made)

->  replace _contrast2_1_lci=100*_contrast2_1_lci
(1,035 real changes made)

->  replace _contrast2_1_uci=100*_contrast2_1_uci
(1,035 real changes made)

. 
. *cumulative mortality at last day of follow-up - write to file 
. file write tablecontent ("Post-hoc: died_covid_any") _tab ("No UDCA") _tab  

. * cumulative outcome - no UDCA 
. sum _at1 if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at1 |          1    19.21125           .   19.21125   19.21125

. file write tablecontent (r(mean)) _tab 

. sum _at1_lci if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_lci |          1    15.52293           .   15.52293   15.52293

. file write tablecontent (r(mean)) _tab 

. sum _at1_uci if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at1_uci |          1    23.77595           .   23.77595   23.77595

. file write tablecontent (r(mean)) _tab _n 

. * cumulative outcome - UDCA 
. file write tablecontent ("`outcome'") _tab ("UDCA") _tab  

. sum _at2 if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        _at2 |          1    14.69446           .   14.69446   14.69446

. file write tablecontent (r(mean)) _tab 

. sum _at2_lci if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_lci |          1    6.967609           .   6.967609   6.967609

. file write tablecontent (r(mean)) _tab 

. sum _at2_uci if days_ph==`tmax'

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
    _at2_uci |          1    30.99013           .   30.99013   30.99013

. file write tablecontent (r(mean)) _tab _n 

. 
. *l date days_ph _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days_ph<.
. 
. twoway  (rarea _at1_lci _at1_uci days_ph, color(red%25)) ///
>                 (rarea _at2_lci _at2_uci days_ph, color(blue%25)) ///
>                 (line _at1 days_ph, sort lcolor(red)) ///
>                 (line _at2 days_ph, sort lcolor(blue) lpattern(dash)) ///
>                 , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(11) 
> region(lwidth(none))) ///
>                 title("Time to `outcome'", justification(left) size(med) )   
>       ///
>                 yscale(range(0, 1))                                          
>                                            ///
>                 ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small)) ///
>                 xlabel(0 (200) 1035, labsize(small))                         
>                                    ///                     
>                 ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                 xtitle("Days since 1 Mar 2020", size(medsmall))              
>    ///
>                 graphregion(fcolor(white)) saving(adjcurv_died_covid_any_post
> _hoc, replace)
(note:  named style med not found in class gsize, default attributes used)
(note: file adjcurv_died_covid_any_post_hoc.gph not found)
(file adjcurv_died_covid_any_post_hoc.gph saved)

. 
. graph export "./output/graphs/adjcurv_died_covid_any_post_hoc.svg", as(svg) r
> eplace
(note: file ./output/graphs/adjcurv_died_covid_any_post_hoc.svg not found)
(file ./output/graphs/adjcurv_died_covid_any_post_hoc.svg written in SVG format
> )

. 
. * Close window 
. graph close    

. 
. * plot for each outcome - fully adjusted 
. foreach outcome in hosp_any composite_any {
  2.     use ./output/an_dataset_`outcome', clear 
  3.     drop if stp==""
  4.     describe
  5.     gen index_date = date("01/03/2020", "DMY")
  6.     bys patient_id (start): gen last = _N==_n 
  7.     tab died_liver_any `outcome'_flag if last==1
  8.     * For sensitivity: generate new stop and update last record to end of 
> study period if died of liver disease 
.     gen stop_new = stop 
  9.     replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_a
> ny==1
 10.     stset stop, fail(`outcome'_flag) id(patient_id) enter(index_date) orig
> in(index_date)
 11. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify 
.     * Fully adjusted model (though not including wave as not right in main mo
> del)
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time
.     * stpm2_standsurv cannot use factor variables so creating dummy variables
> :
.     tab imd, gen(imd) 
 12.     tab bmi_cat, gen(bmi_cat)
 13.     tab smoking, gen(smoking)
 14.     * Check all binary 
.     foreach vars in udca male any_high_risk_condition eth_bin imd1 imd2 imd3 
> imd4 imd5 bmi_cat1 bmi_cat2 bmi_cat3 ///
>     bmi_cat4 bmi_cat5 smoking1 smoking2 smoking3 severe_disease covid_vacc_fi
> rst liver_trans {
 15.         tab `vars', m nolabel
 16.         } 
 17.       
.     * fully adjusted model to fit 
.     stpm2 udca male age_tv any_high_risk_condition eth_bin imd2 imd3 imd4 imd
> 5 bmi_cat1 bmi_cat3 ///
>     bmi_cat4 bmi_cat5 smoking2 smoking3 severe_disease covid_vacc_first liver
> _trans, ///
>      tvc(udca severe_disease covid_vacc_first liver_trans age_tv) dftvc(1) df
> (2) scale(hazard) eform
 18.     
.     summ _t
 19.     local tmax=r(max)
 20.     local tmaxplus1=r(max)+1
 21. 
.     range days 0 `tmax' `tmaxplus1'
 22.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci
>  contrast(difference) fail
 23.     gen date = d(1/3/2020)+ days
 24.     format date %tddd_Month
 25. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 26. 
.     *cumulative mortality at last day of follow-up
.     list _at1* if days==`tmax', noobs
 27.     list _at2* if days==`tmax', noobs
 28.     list _contrast* if days==`tmax', noobs
 29. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("`outcome' fully adjusted") _tab ("No UDCA") _ta
> b  
 30.     * cumulative outcome - no UDCA 
.     sum _at1 if days==`tmax'
 31.     file write tablecontent (r(mean)) _tab 
 32.     sum _at1_lci if days==`tmax'
 33.     file write tablecontent (r(mean)) _tab 
 34.     sum _at1_uci if days==`tmax'
 35.     file write tablecontent (r(mean)) _tab _n 
 36.     * cumulative outcome - UDCA 
.     file write tablecontent ("`outcome'") _tab ("UDCA") _tab  
 37.     sum _at2 if days==`tmax'
 38.     file write tablecontent (r(mean)) _tab 
 39.     sum _at2_lci if days==`tmax'
 40.     file write tablecontent (r(mean)) _tab 
 41.     sum _at2_uci if days==`tmax'
 42.     file write tablecontent (r(mean)) _tab _n 
 43. 
.     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
.     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days, color(blue%25)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_f_`outcome', re
> place)
 44. 
.     graph export "./output/graphs/adjcurv_f_`outcome'.svg", as(svg) replace
 45. 
.     * Close window 
.     graph close
 46. 
.     * Post-hoc analysis: Model with liver deaths not censored
.     use ./output/an_dataset_`outcome', clear 
 47.     drop if stp==""
 48.     describe
 49.     gen index_date = date("01/03/2020", "DMY")
 50.     bys patient_id (start): gen last = _N==_n 
 51.     tab died_liver_any `outcome'_flag if last==1
 52.     * For sensitivity: generate new stop and update last record to end of 
> study period if died of liver disease 
.     gen stop_new = stop 
 53.     replace stop_new = date("31/12/2022", "DMY") if last==1 & died_liver_a
> ny==1
 54.     stset stop_new, fail(`outcome'_flag) id(patient_id) enter(index_date) 
> origin(index_date)
 55. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot use tvc and stratify  
.     
.     * Age and sex adjusted model 
.     * Setting df (degrees of freedom for restricted cubic splines) as 3 as th
> is is default 
.     * Setting dftvc (degrees of freedom for time-dependent effects) as 1 = li
> near effect of log time 
.     * fully adjusted model to fit 
.     stpm2 udca male age_tv any_high_risk_condition eth_bin imd2 imd3 imd4 imd
> 5 bmi_cat1 bmi_cat3 ///
>     bmi_cat4 bmi_cat5 smoking2 smoking3 severe_disease covid_vacc_first liver
> _trans, ///
>      tvc(udca severe_disease covid_vacc_first liver_trans age_tv) dftvc(1) df
> (2) scale(hazard) eform
 56.     
.     summ _t
 57.     local tmax=r(max)
 58.     local tmaxplus1=r(max)+1
 59. 
.     range days_ph 0 `tmax' `tmaxplus1'
 60.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days_ph)
>  ci contrast(difference) fail
 61. 
.     gen date = d(1/3/2020)+ days_ph
 62.     format date %tddd_Month
 63. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 64. 
.     *cumulative mortality at last day of follow-up - write to file 
.     file write tablecontent ("Post-hoc: `outcome'") _tab ("No UDCA") _tab  
 65.     * cumulative outcome - no UDCA 
.     sum _at1 if days_ph==`tmax'
 66.     file write tablecontent (r(mean)) _tab 
 67.     sum _at1_lci if days_ph==`tmax'
 68.     file write tablecontent (r(mean)) _tab 
 69.     sum _at1_uci if days_ph==`tmax'
 70.     file write tablecontent (r(mean)) _tab _n 
 71.     * cumulative outcome - UDCA 
.     file write tablecontent ("`outcome'") _tab ("UDCA") _tab  
 72.     sum _at2 if days_ph==`tmax'
 73.     file write tablecontent (r(mean)) _tab 
 74.     sum _at2_lci if days_ph==`tmax'
 75.     file write tablecontent (r(mean)) _tab 
 76.     sum _at2_uci if days_ph==`tmax'
 77.     file write tablecontent (r(mean)) _tab _n 
 78.     
.     *l date days_ph _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days_ph<
> .
. 
.     twoway  (rarea _at1_lci _at1_uci days_ph, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days_ph, color(blue%25)) ///
>                     (line _at1 days_ph, sort lcolor(red)) ///
>                     (line _at2 days_ph, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (1) 10, angle(0) format(%4.1f) labsize(small))  
>    ///
>                     xlabel(0 (200) 1035, labsize(small))                     
>                                            ///                     
>                     ytitle("Cumulative outcomes (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
 79. 
.     graph export "./output/graphs/adjcurv_f_`outcome'_post_hoc.svg", as(svg) 
> replace
 80. 
.     * Close window 
.     graph close
 81. 
. }
(1,463 observations deleted)

Contains data from ./output/an_dataset_hosp_any.dta
  obs:         1,470                          
 vars:            23                          9 Oct 2023 10:58
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
has_pbc         byte    %8.0g                 
oca_bl          byte    %8.0g                 
patient_id      int     %8.0g                 
male            float   %9.0g                 
eth_bin         float   %9.0g      eth_3      
bmi_cat         float   %14.0g     bmi        
smoking         float   %14.0g     smok       
any_high_risk~n float   %9.0g                 
time_vacc_cat   byte    %23.0g     vacc_t     4 quantiles of time_vacc
died_liver_any  float   %9.0g                 
died_liver_un~g float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
hosp_any_flag   float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
total_hosp      float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

died_liver |     hosp_any_flag
      _any |         0          1 |     Total
-----------+----------------------+----------
         0 |       349         25 |       374 
         1 |       122          4 |       126 
-----------+----------------------+----------
     Total |       471         29 |       500 
(92 real changes made)

                id:  patient_id
     failure event:  hosp_any_flag != 0 & hosp_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      1,470  total observations
          0  exclusions
------------------------------------------------------------------------------
      1,470  observations remaining, representing
        500  subjects
         29  failures in single-failure-per-subject data
    325,834  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035

        imd |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        298       20.27       20.27
          2 |        278       18.91       39.18
          3 |        279       18.98       58.16
          4 |        246       16.73       74.90
          5 |        303       20.61       95.51
          6 |         66        4.49      100.00
------------+-----------------------------------
      Total |      1,470      100.00

       bmi_cat |      Freq.     Percent        Cum.
---------------+-----------------------------------
   Underweight |        159       10.82       10.82
 Healthy range |        553       37.62       48.44
    Overweight |        290       19.73       68.16
         Obese |        373       25.37       93.54
Morbidly obese |         95        6.46      100.00
---------------+-----------------------------------
         Total |      1,470      100.00

       smoking |      Freq.     Percent        Cum.
---------------+-----------------------------------
  Never smoked |        182       12.38       12.38
Current smoker |      1,065       72.45       84.83
     Ex-smoker |        223       15.17      100.00
---------------+-----------------------------------
         Total |      1,470      100.00

       udca |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,324       90.07       90.07
          1 |        146        9.93      100.00
------------+-----------------------------------
      Total |      1,470      100.00

       male |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        759       51.63       51.63
          1 |        700       47.62       99.25
          . |         11        0.75      100.00
------------+-----------------------------------
      Total |      1,470      100.00

any_high_ri |
sk_conditio |
          n |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |      1,470      100.00      100.00
------------+-----------------------------------
      Total |      1,470      100.00

    eth_bin |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        198       13.47       13.47
          1 |      1,211       82.38       95.85
          2 |         61        4.15      100.00
------------+-----------------------------------
      Total |      1,470      100.00

      imd== |
     1.0000 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,172       79.73       79.73
          1 |        298       20.27      100.00
------------+-----------------------------------
      Total |      1,470      100.00

      imd== |
     2.0000 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,192       81.09       81.09
          1 |        278       18.91      100.00
------------+-----------------------------------
      Total |      1,470      100.00

      imd== |
     3.0000 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,191       81.02       81.02
          1 |        279       18.98      100.00
------------+-----------------------------------
      Total |      1,470      100.00

      imd== |
     4.0000 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,224       83.27       83.27
          1 |        246       16.73      100.00
------------+-----------------------------------
      Total |      1,470      100.00

      imd== |
     5.0000 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,167       79.39       79.39
          1 |        303       20.61      100.00
------------+-----------------------------------
      Total |      1,470      100.00

bmi_cat==Un |
  derweight |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,311       89.18       89.18
          1 |        159       10.82      100.00
------------+-----------------------------------
      Total |      1,470      100.00

bmi_cat==He |
althy range |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        917       62.38       62.38
          1 |        553       37.62      100.00
------------+-----------------------------------
      Total |      1,470      100.00

bmi_cat==Ov |
   erweight |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,180       80.27       80.27
          1 |        290       19.73      100.00
------------+-----------------------------------
      Total |      1,470      100.00

bmi_cat==Ob |
        ese |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,097       74.63       74.63
          1 |        373       25.37      100.00
------------+-----------------------------------
      Total |      1,470      100.00

bmi_cat==Mo |
     rbidly |
      obese |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,375       93.54       93.54
          1 |         95        6.46      100.00
------------+-----------------------------------
      Total |      1,470      100.00

smoking==Ne |
 ver smoked |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,288       87.62       87.62
          1 |        182       12.38      100.00
------------+-----------------------------------
      Total |      1,470      100.00

smoking==Cu |
      rrent |
     smoker |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        405       27.55       27.55
          1 |      1,065       72.45      100.00
------------+-----------------------------------
      Total |      1,470      100.00

smoking==Ex |
    -smoker |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,247       84.83       84.83
          1 |        223       15.17      100.00
------------+-----------------------------------
      Total |      1,470      100.00

severe_dise |
        ase |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        573       38.98       38.98
          1 |        897       61.02      100.00
------------+-----------------------------------
      Total |      1,470      100.00

covid_vacc_ |
      first |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,188       80.82       80.82
          1 |        282       19.18      100.00
------------+-----------------------------------
      Total |      1,470      100.00

liver_trans |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      1,460       99.32       99.32
          1 |         10        0.68      100.00
------------+-----------------------------------
      Total |      1,470      100.00
note: delayed entry models are being fitted
note: any_high_risk_condition omitted because of collinearity

initial values not feasible
r(1400);

end of do-file
r(1400);

end of do-file

r(1400);


