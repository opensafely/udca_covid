
. * plot for each outcome 
. * Initially just try composite outcome
. foreach outcome in died_covid_any hosp_any composite_any {
  2.     use ./output/an_dataset_`outcome', clear 
  3.     describe
  4.     gen index_date = date("01/03/2020", "DMY")
  5.     stset stop, fail(`outcome'_flag) id(patient_id) enter(index_date) orig
> in(index_date)
  6. 
.     * Add cumulative incidence plots 
.     * Not stratifying by stp as cannot tvc and stratify 
.           
.     stpm2 udca age_tv male any_high_risk_condition i.ethnicity i.imd bmi_cat 
> i.smoking severe_disease covid_vacc_first liver_trans i.wave, ///
>      tvc(udca severe_disease covid_vacc_first liver_trans) dftvc(1) df(3) sca
> le(hazard) eform
  7. 
.     stpm2 udca age_tv male, tvc(udca) dftvc(1) df(3) scale(hazard) eform
  8.     summ _t
  9.     local tmax=r(max)
 10.     local tmaxplus1=r(max)+1
 11. 
.     range days 0 `tmax' `tmaxplus1'
 12.     stpm2_standsurv if udca == 1, at1(udca 0) at2(udca 1) timevar(days) ci
>  contrast(difference) fail
 13. 
.     gen date = d(1/3/2020)+ days
 14.     format date %tddd_Month
 15. 
.     for var _at1 _at2 _at1_lci _at1_uci _at2_lci _at2_uci _contrast2_1 _contr
> ast2_1_lci _contrast2_1_uci: replace X=100*X
 16. 
.     *cumulative mortality at last day of follow-up
.     list _at1* if days==`tmax', noobs
 17.     list _at2* if days==`tmax', noobs
 18.     list _contrast* if days==`tmax', noobs
 19. 
.     *l date days _at1 _at1_lci _at1_uci _at2 _at2_lci _at2_uci if days<.
. 
.     twoway  (rarea _at1_lci _at1_uci days, color(red%25)) ///
>                     (rarea _at2_lci _at2_uci days if _at2_uci<1, color(blue%2
> 5)) ///
>                     (line _at1 days, sort lcolor(red)) ///
>                     (line _at2 days, sort lcolor(blue) lpattern(dash)) ///
>                     , legend(order(1 "No UDCA" 2 "UDCA") ring(0) cols(1) pos(
> 11) region(lwidth(none))) ///
>                     title("Time to `outcome'", justification(left) size(med) 
> )             ///
>                     yscale(range(0, 1))                                      
>                                                    ///
>                     ylabel(0 (0.1) 1, angle(0) format(%4.1f) labsize(small)) 
>    ///
>                     xlabel(0 (20) 160, labsize(small))                       
>                                    ///                     
>                     ytitle("Cumulative mortality (%)", size(medsmall)) ///
>                     xtitle("Days since 1 Mar 2020", size(medsmall))          
>            ///
>                     graphregion(fcolor(white)) saving(adjcurv_`outcome', repl
> ace)
 20. 
.     graph export ./output/graphs/adjcurv_`outcome'.svg", as(svg) replace
 21. 
.     * Close window 
.     graph close
 22. 
. }

Contains data from ./output/an_dataset_died_covid_any.dta
  obs:         4,967                          
 vars:            17                          10 Jul 2023 12:26
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
stp             str4    %9s                   
imd             byte    %8.0g                 
ethnicity       byte    %8.0g      eth5       
patient_id      int     %8.0g                 
male            float   %9.0g                 
bmi_cat         float   %14.0g     bmi        
smoking         float   %9.0g                 
any_high_risk~n float   %9.0g                 
start           float   %9.0g                 
stop            float   %9.0g                 
died_covid_an~g byte    %8.0g                 
wave            float   %9.0g                 
age_tv          float   %9.0g                 
udca            float   %9.0g                 
liver_trans     float   %9.0g                 
covid_vacc_fi~t float   %9.0g                 
severe_disease  float   %9.0g                 
-------------------------------------------------------------------------------
Sorted by: 

                id:  patient_id
     failure event:  died_covid_any_flag != 0 & died_covid_any_flag < .
obs. time interval:  (stop[_n-1], stop]
 enter on or after:  time index_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time index_date

------------------------------------------------------------------------------
      4,967  total observations
          0  exclusions
------------------------------------------------------------------------------
      4,967  observations remaining, representing
      1,000  subjects
        153  failures in single-failure-per-subject data
    651,528  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =     1,035
note: delayed entry models are being fitted
note: any_high_risk_condition omitted because of collinearity

initial values not feasible
r(1400);

end of do-file
r(1400);

end of do-file

r(1400);


