
. 
. cap mkdir ./output/tables/

. 
. /** First import udca population
> import delimited using ./output/input.csv
> 
> * Format dates 
> foreach var in udca_last_date udca_first_after udca_first_history died_date_o
> ns {
>     gen `var'A = date(`var', "YMD")
>     format `var'A %dD/N/CY
>     *list `var' `var'A in  1/5
>     drop `var'
> }
> 
> /* DEMOGRAPHICS */ 
> 
> * Sex
> gen male = 1 if sex == "M"
> replace male = 0 if sex == "F"
> 
> /*  Age variables  */ 
> 
> * Create categorised age
> recode age 18/39.9999 = 1 /// 
>            40/49.9999 = 2 ///
>                    50/59.9999 = 3 ///
>                60/69.9999 = 4 ///
>                    70/79.9999 = 5 ///
>                    80/max = 6, gen(agegroup) 
> 
> label define agegroup   1 "18-<40" ///
>                                                 2 "40-<50" ///
>                                                 3 "50-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"
>                                                 
> label values agegroup agegroup
> 
> /* EXPOSURE INFORMATION ====================================================*
> /
> rename udca_last_date udca_date
> gen udca = 1 if udca_count != . & udca_count >= 2
> recode udca .=0
> 
> gen udca_sa = 1 if udca_count != . & udca_count >= 1 & udca_date != . & udca_
> date >= mdy(12,1,2019)
> recode udca_sa .=0
> 
> tab1 udca udca_sa, m
> tab udca udca_sa, m
> 
> *tab  udca_count udca, m
> 
> * when was first udca Rx before index date
> gen udca_first = 0 if udca == 0
> replace udca_first = 1 if udca == 1 & udca_first_history >= mdy(9,1,2019) & u
> dca_first_history < mdy(3,1,2020) 
> replace udca_first = 2 if udca == 1 & udca_first_history >= mdy(3,1,2019) & u
> dca_first_history < mdy(9,1,2019) 
> replace udca_first = 3 if udca == 1 & udca_first_history >= mdy(9,1,2018) & u
> dca_first_history < mdy(3,1,2019) 
> replace udca_first = 4 if udca == 1 & udca_first_history >= mdy(9,1,2017) & u
> dca_first_history < mdy(9,1,2018) 
> replace udca_first = 5 if udca == 1 & udca_first_history >= mdy(9,1,2016) & u
> dca_first_history < mdy(9,1,2017) 
> replace udca_first = 6 if udca == 1 & udca_first_history >= mdy(9,1,2015) & u
> dca_first_history < mdy(9,1,2016) 
> replace udca_first = 7 if udca == 1 & udca_first_history >= mdy(9,1,2014) & u
> dca_first_history < mdy(9,1,2015) 
> replace udca_first = 8 if udca == 1 &                                        
>                                      udca_first_history < mdy(9,1,2014) 
> 
> label define udca_first         0 "unexposed"                                
>                            ///
>                                                 1 "within exposure window"   
>                                    ///
>                                                 2 "up to 6 mos before exposur
> e window"          ///
>                                                 3 "6 mos to 1 yr before expos
> ure window"        ///
>                                                 4 "1 to 2 yr before exposure 
> window"            ///
>                                                 5 "2 to 3 yr before exposure 
> window"            ///
>                                                 6 "3 to 4 yr before exposure 
> window"            ///
>                                                 7 "4 to 5 yr before exposure 
> window"            ///
>                                                 8 "5+ yr before exposure wind
> ow"
> label values udca_first udca_first
> 
> * Flag if died
> gen died_flag = died_date_onsA!=.
> * Generate date if died of covid
> gen died_date_onscovid = died_date_onsA if died_ons_covid_flag_any == 1
> 
> gen died_covid_2020 = (died_date_onscovid<date("31Dec2020", "DMY") & died_fla
> g==1)
> 
> gen pbc_psc = (has_pbc==1)
> replace pbc_psc = 2 if has_psc==1
> tab pbc_psc, m
> tab has_pbc has_psc 
> 
> **** Summary INFORMATION
> ** Currently dataset includes all people with at least one udca prescription
> * Tabulate pbc diagnosis vs those with 2+ prescriptions in 6 months prior
> tab has_pbc udca, m 
> 
> * Tabulating time since first prescription by whether have 2+ prescriptions i
> n the last 6 months
> tab udca_first udca, m col
> 
> bys udca: sum udca_count
> 
> * Export to table 
> preserve
> table1_mc, by(udca) vars(has_pbc bin \ has_psc bin) saving(./output/tables/ud
> ca_all.xlsx, replace)
> restore 
> 
> * How many COVID-19 deaths in those with pbc and 2+ prescriptions
> tab died_ons_covid_flag_any has_pbc if udca==1, row
> tab died_covid_2020 has_pbc if udca==1, row col
> tab died_flag has_pbc if udca==1, row col
> 
> * How many COVID-19 deaths in those with psc and 2+ prescriptions
> tab died_ons_covid_flag_any has_psc if udca==1, row
> tab died_covid_2020 has_psc if udca==1, row col
> tab died_flag has_psc if udca==1, row col
> 
> * Summary demographics
> tab agegroup has_pbc if udca==1, row col m 
> tab sex has_pbc if udca==1, row col m 
> 
> tab agegroup has_psc if udca==1, row col m 
> tab sex has_psc if udca==1, row col m 
> 
> * Export to table 
> keep if udca==1
> table1_mc, by(has_pbc) vars(died_ons_covid_flag_any bin \ died_covid_2020 bin
>  \ died_flag bin \ agegroup cat \ male bin) saving(./output/tables/udca_only.
> xlsx, replace)
> 
> table1_mc, by(has_pbc) vars(udca_first cat) saving(./output/tables/udca_first
> _only.xlsx, replace)
> 
> table1_mc, by(has_psc) vars(died_ons_covid_flag_any bin \ died_covid_2020 bin
>  \ died_flag bin \ agegroup cat \ male bin) saving(./output/tables/udca_only.
> xlsx, replace)
> 
> table1_mc, by(has_psc) vars(udca_first cat) saving(./output/tables/udca_first
> _only.xlsx, replace)
> 
> * Deaths in those prescribed OBA with PBC 
> keep if has_pbc 
> table1_mc, by(oba) vars(died_ons_covid_flag_any bin \ died_covid_2020 bin \ d
> ied_flag bin \ agegroup cat \ male bin) saving(./output/tables/oba_only.xlsx,
>  replace) 
> */
. ** Next import the PBC population
. 
. import delimited using ./output/input_pbc.csv, clear
(17 vars, 1,000 obs)

. 
. * Format dates 
. foreach var in udca_last_date udca_first_after udca_first_history died_date_o
> ns {
  2.     gen `var'A = date(`var', "YMD")
  3.     format `var'A %dD/N/CY
  4.     *list `var' `var'A in  1/5
.     drop `var'
  5. }
(500 missing values generated)
(500 missing values generated)
(500 missing values generated)
(500 missing values generated)

. 
. /* DEMOGRAPHICS */ 
. 
. * Sex
. gen male = 1 if sex == "M"
(536 missing values generated)

. replace male = 0 if sex == "F"
(529 real changes made)

. 
. /*  Age variables  */ 
. 
. * Create categorised age
. recode age 18/39.9999 = 1 /// 
>            40/49.9999 = 2 ///
>                    50/59.9999 = 3 ///
>                60/69.9999 = 4 ///
>                    70/79.9999 = 5 ///
>                    80/max = 6, gen(agegroup) 
(772 differences between age and agegroup)

. 
. label define agegroup   1 "18-<40" ///
>                                                 2 "40-<50" ///
>                                                 3 "50-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

.                                                 
. label values agegroup agegroup

. 
. /* EXPOSURE INFORMATION ====================================================*
> /
. rename udca_last_date udca_date

. gen udca = 1 if udca_count != . & udca_count >= 2
(794 missing values generated)

. recode udca .=0
(udca: 794 changes made)

. 
. gen udca_sa = 1 if udca_count != . & udca_count >= 1 & udca_date != . & udca_
> date >= mdy(12,1,2019)
(946 missing values generated)

. recode udca_sa .=0
(udca_sa: 946 changes made)

. 
. tab1 udca udca_sa, m

-> tabulation of udca  

       udca |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        794       79.40       79.40
          1 |        206       20.60      100.00
------------+-----------------------------------
      Total |      1,000      100.00

-> tabulation of udca_sa  

    udca_sa |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        946       94.60       94.60
          1 |         54        5.40      100.00
------------+-----------------------------------
      Total |      1,000      100.00

. tab udca udca_sa, m

           |        udca_sa
      udca |         0          1 |     Total
-----------+----------------------+----------
         0 |       782         12 |       794 
         1 |       164         42 |       206 
-----------+----------------------+----------
     Total |       946         54 |     1,000 

. 
. *tab  udca_count udca, m
. 
. * when was first udca Rx before index date
. gen udca_first = 0 if udca == 0
(206 missing values generated)

. replace udca_first = 1 if udca == 1 & udca_first_history >= mdy(9,1,2019) & u
> dca_first_history < mdy(3,1,2020) 
(0 real changes made)

. replace udca_first = 2 if udca == 1 & udca_first_history >= mdy(3,1,2019) & u
> dca_first_history < mdy(9,1,2019) 
(0 real changes made)

. replace udca_first = 3 if udca == 1 & udca_first_history >= mdy(9,1,2018) & u
> dca_first_history < mdy(3,1,2019) 
(0 real changes made)

. replace udca_first = 4 if udca == 1 & udca_first_history >= mdy(9,1,2017) & u
> dca_first_history < mdy(9,1,2018) 
(0 real changes made)

. replace udca_first = 5 if udca == 1 & udca_first_history >= mdy(9,1,2016) & u
> dca_first_history < mdy(9,1,2017) 
(0 real changes made)

. replace udca_first = 6 if udca == 1 & udca_first_history >= mdy(9,1,2015) & u
> dca_first_history < mdy(9,1,2016) 
(2 real changes made)

. replace udca_first = 7 if udca == 1 & udca_first_history >= mdy(9,1,2014) & u
> dca_first_history < mdy(9,1,2015) 
(1 real change made)

. replace udca_first = 8 if udca == 1 &                                        
>                                      udca_first_history < mdy(9,1,2014) 
(98 real changes made)

. 
. label define udca_first         0 "unexposed"                                
>                            ///
>                                                 1 "within exposure window"   
>                                    ///
>                                                 2 "up to 6 mos before exposur
> e window"          ///
>                                                 3 "6 mos to 1 yr before expos
> ure window"        ///
>                                                 4 "1 to 2 yr before exposure 
> window"            ///
>                                                 5 "2 to 3 yr before exposure 
> window"            ///
>                                                 6 "3 to 4 yr before exposure 
> window"            ///
>                                                 7 "4 to 5 yr before exposure 
> window"            ///
>                                                 8 "5+ yr before exposure wind
> ow"

. label values udca_first udca_first

. 
. * Flag if died
. gen died_flag = died_date_onsA!=.

. * Generate date if died of covid
. gen died_date_onscovid = died_date_onsA if died_ons_covid_flag_any == 1
(759 missing values generated)

. gen died_covid_2020 = (died_date_onscovid<date("31Dec2020", "DMY") & died_fla
> g==1)

. 
. **** Summary INFORMATION
. ** Currently dataset includes all people with a pbc or psc diagnosis, how man
> y have 2+ udca prescription
. * Tabulate pbc or psc diagnosis vs those with 2+ prescriptions in 6 months pr
> ior
. tab udca, m 

       udca |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |        794       79.40       79.40
          1 |        206       20.60      100.00
------------+-----------------------------------
      Total |      1,000      100.00

. 
. * Determine number with psc vs pbc with 2+ prescriptions
. tab has_pbc has_psc if udca==1

           |        has_psc
   has_pbc |         0          1 |     Total
-----------+----------------------+----------
         0 |        54         45 |        99 
         1 |        64         43 |       107 
-----------+----------------------+----------
     Total |       118         88 |       206 

. 
. * Tabulating time since first prescription by whether have 2+ prescriptions i
> n the last 6 months
. tab udca_first udca, col m

+-------------------+
| Key               |
|-------------------|
|     frequency     |
| column percentage |
+-------------------+

                      |         udca
           udca_first |         0          1 |     Total
----------------------+----------------------+----------
            unexposed |       794          0 |       794 
                      |    100.00       0.00 |     79.40 
----------------------+----------------------+----------
3 to 4 yr before expo |         0          2 |         2 
                      |      0.00       0.97 |      0.20 
----------------------+----------------------+----------
4 to 5 yr before expo |         0          1 |         1 
                      |      0.00       0.49 |      0.10 
----------------------+----------------------+----------
5+ yr before exposure |         0         98 |        98 
                      |      0.00      47.57 |      9.80 
----------------------+----------------------+----------
                    . |         0        105 |       105 
                      |      0.00      50.97 |     10.50 
----------------------+----------------------+----------
                Total |       794        206 |     1,000 
                      |    100.00     100.00 |    100.00 

. 
. * Check number of prescriptions
. bys udca: sum udca_count

-------------------------------------------------------------------------------
-> udca = 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
  udca_count |        794    .0453401    .2978861         -3          1

-------------------------------------------------------------------------------
-> udca = 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
  udca_count |        206    3.519417    1.447323          2          9


. 
. * How many COVID-19 deaths by whether had 2+ prescriptions
. tab died_ons_covid_flag_any udca, row col 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

died_ons_c |
ovid_flag_ |         udca
       any |         0          1 |     Total
-----------+----------------------+----------
         0 |       404         96 |       500 
           |     80.80      19.20 |    100.00 
           |     50.88      46.60 |     50.00 
-----------+----------------------+----------
         1 |       390        110 |       500 
           |     78.00      22.00 |    100.00 
           |     49.12      53.40 |     50.00 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. tab died_covid_2020 udca, row col 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

died_covid |         udca
     _2020 |         0          1 |     Total
-----------+----------------------+----------
         0 |       745        196 |       941 
           |     79.17      20.83 |    100.00 
           |     93.83      95.15 |     94.10 
-----------+----------------------+----------
         1 |        49         10 |        59 
           |     83.05      16.95 |    100.00 
           |      6.17       4.85 |      5.90 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. tab died_flag udca, row col 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

           |         udca
 died_flag |         0          1 |     Total
-----------+----------------------+----------
         0 |       391        109 |       500 
           |     78.20      21.80 |    100.00 
           |     49.24      52.91 |     50.00 
-----------+----------------------+----------
         1 |       403         97 |       500 
           |     80.60      19.40 |    100.00 
           |     50.76      47.09 |     50.00 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. 
. 
. * Summary demographics
. tab agegroup udca, row col m 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

 RECODE of |         udca
       age |         0          1 |     Total
-----------+----------------------+----------
         0 |        14          4 |        18 
           |     77.78      22.22 |    100.00 
           |      1.76       1.94 |      1.80 
-----------+----------------------+----------
    18-<40 |       232         54 |       286 
           |     81.12      18.88 |    100.00 
           |     29.22      26.21 |     28.60 
-----------+----------------------+----------
    40-<50 |       110         34 |       144 
           |     76.39      23.61 |    100.00 
           |     13.85      16.50 |     14.40 
-----------+----------------------+----------
    50-<60 |       112         30 |       142 
           |     78.87      21.13 |    100.00 
           |     14.11      14.56 |     14.20 
-----------+----------------------+----------
    60-<70 |        96         32 |       128 
           |     75.00      25.00 |    100.00 
           |     12.09      15.53 |     12.80 
-----------+----------------------+----------
    70-<80 |        64         19 |        83 
           |     77.11      22.89 |    100.00 
           |      8.06       9.22 |      8.30 
-----------+----------------------+----------
       80+ |        48         10 |        58 
           |     82.76      17.24 |    100.00 
           |      6.05       4.85 |      5.80 
-----------+----------------------+----------
         7 |        12          1 |        13 
           |     92.31       7.69 |    100.00 
           |      1.51       0.49 |      1.30 
-----------+----------------------+----------
         8 |        16          4 |        20 
           |     80.00      20.00 |    100.00 
           |      2.02       1.94 |      2.00 
-----------+----------------------+----------
         9 |         7          2 |         9 
           |     77.78      22.22 |    100.00 
           |      0.88       0.97 |      0.90 
-----------+----------------------+----------
        10 |        14          4 |        18 
           |     77.78      22.22 |    100.00 
           |      1.76       1.94 |      1.80 
-----------+----------------------+----------
        11 |        17          0 |        17 
           |    100.00       0.00 |    100.00 
           |      2.14       0.00 |      1.70 
-----------+----------------------+----------
        12 |         6          2 |         8 
           |     75.00      25.00 |    100.00 
           |      0.76       0.97 |      0.80 
-----------+----------------------+----------
        13 |        11          3 |        14 
           |     78.57      21.43 |    100.00 
           |      1.39       1.46 |      1.40 
-----------+----------------------+----------
        14 |         9          5 |        14 
           |     64.29      35.71 |    100.00 
           |      1.13       2.43 |      1.40 
-----------+----------------------+----------
        15 |         7          1 |         8 
           |     87.50      12.50 |    100.00 
           |      0.88       0.49 |      0.80 
-----------+----------------------+----------
        16 |        13          1 |        14 
           |     92.86       7.14 |    100.00 
           |      1.64       0.49 |      1.40 
-----------+----------------------+----------
        17 |         6          0 |         6 
           |    100.00       0.00 |    100.00 
           |      0.76       0.00 |      0.60 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. tab sex udca, row col m 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

           |         udca
       sex |         0          1 |     Total
-----------+----------------------+----------
         F |       414        115 |       529 
           |     78.26      21.74 |    100.00 
           |     52.14      55.83 |     52.90 
-----------+----------------------+----------
         M |       374         90 |       464 
           |     80.60      19.40 |    100.00 
           |     47.10      43.69 |     46.40 
-----------+----------------------+----------
         U |         6          1 |         7 
           |     85.71      14.29 |    100.00 
           |      0.76       0.49 |      0.70 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. tab oba udca, row col m 

+-------------------+
| Key               |
|-------------------|
|     frequency     |
|  row percentage   |
| column percentage |
+-------------------+

           |         udca
       oba |         0          1 |     Total
-----------+----------------------+----------
         0 |       401         99 |       500 
           |     80.20      19.80 |    100.00 
           |     50.50      48.06 |     50.00 
-----------+----------------------+----------
         1 |       393        107 |       500 
           |     78.60      21.40 |    100.00 
           |     49.50      51.94 |     50.00 
-----------+----------------------+----------
     Total |       794        206 |     1,000 
           |     79.40      20.60 |    100.00 
           |    100.00     100.00 |    100.00 

. 
. * Export to table 
. * First drop out categories that will not be in real data > should be zero on
>  server
. drop if agegroup<1 | agegroup>6
(159 observations deleted)

. table1_mc, by(udca) vars(has_pbc bin \ died_ons_covid_flag_any bin \ died_cov
> id_2020 bin \ died_flag bin \ agegroup cat \ male bin) saving(./output/tables
> /udca_pbc.xlsx, replace)

  +-------------------------------------------------+
  | factor                    N_0   N_1   m_0   m_1 |
  |-------------------------------------------------|
  | has_pbc                   662   179     0     0 |
  |-------------------------------------------------|
  | died_ons_covid_flag_any   662   179     0     0 |
  |-------------------------------------------------|
  | died_covid_2020           662   179     0     0 |
  |-------------------------------------------------|
  | died_flag                 662   179     0     0 |
  |-------------------------------------------------|
  | RECODE of age             662   179     0     0 |
  |-------------------------------------------------|
  | male                      657   178     5     1 |
  +-------------------------------------------------+
   N_ ... #records used below,   m_ ... #records not used
 
  +-----------------------------------------------------------------------+
  |                                    udca = 0      udca = 1     p-value |
  |-----------------------------------------------------------------------|
  |                                    N=662         N=179                |
  |-----------------------------------------------------------------------|
  | has_pbc                            322 (48.6%)   92 (51.4%)    0.51   |
  |-----------------------------------------------------------------------|
  | died_ons_covid_flag_any            327 (49.4%)   96 (53.6%)    0.31   |
  |-----------------------------------------------------------------------|
  | died_covid_2020                    44 ( 6.6%)    9 ( 5.0%)     0.43   |
  |-----------------------------------------------------------------------|
  | died_flag                          340 (51.4%)   86 (48.0%)    0.43   |
  |-----------------------------------------------------------------------|
  | RECODE of age             18-<40   232 (35.0%)   54 (30.2%)    0.67   |
  |                           40-<50   110 (16.6%)   34 (19.0%)           |
  |                           50-<60   112 (16.9%)   30 (16.8%)           |
  |                           60-<70   96 (14.5%)    32 (17.9%)           |
  |                           70-<80   64 ( 9.7%)    19 (10.6%)           |
  |                           80+      48 ( 7.3%)    10 ( 5.6%)           |
  |-----------------------------------------------------------------------|
  | male                               306 (46.6%)   83 (46.6%)    0.99   |
  +-----------------------------------------------------------------------+
Data are presented as n (%).
 
file ./output/tables/udca_pbc.xlsx saved

. 
. foreach var in /*all only*/ pbc /*first_only*/ {
  2.         import excel using ./output/tables/udca_`var'.xlsx, clear
  3.         export delimited using ./output/tables/udca_`var'.csv, replace 
  4. }
(13 vars, 13 obs)
(note: file ./output/tables/udca_pbc.csv not found)
file ./output/tables/udca_pbc.csv saved

. 
. *import excel using ./output/tables/oba_only.xlsx, clear 
. *export delimited using ./output/tables/oba_only.csv, replace 
. 
. 
. 
. 
end of do-file

. . file open output using "/tmp/feasibility.do.5OzW.out", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


